# ThreadLocal

## 一、ThreadLocal介绍

### 1.1 什么是[ThreadLocal](https://blog.csdn.net/qq_45966440/article/details/122330153)

​		**ThreadLocal用来提供线程内部的局部变量**。这种变量在多线程环境下访问（通过`get`和`set`方法访问）时能保证各个线程的变量相对独立于其他线程内的变量。ThreadLocal实例通常来说都是`private static`类型的，用于关联线程和线程上下文。



### 1.2 ThreadLocal的作用

> ​		提供线程内的局部变量，变量在不同的线程之间不会相互干扰，这种变量在线程的生命周期内起作用，减少同一个线程内多个函数或组件之间一些公共变量传递的复杂度。

总结成三个特点：

1. **线程并发**：在多线程并发的场景下
2. **传递数据**：我们可以通过ThreadLocal在同一线程的不同组件中传递公共变量
3. **线程隔离**：线程隔离即线程间数据的隔离，每个线程的变量都是独立的，不会互相影响





## 二、ThreadLocal的基本使用

### 2.1 常用方法

`ThreadLocal`的常用方法：

| 方法声明                  | 描述                       |
| ------------------------- | -------------------------- |
| ThreadLocal()             | 创建ThreadLocal对象        |
| public void set( T value) | 设置当前线程绑定的局部变量 |
| public T get()            | 获取当前线程绑定的局部变量 |
| public void remove()      | 移除当前线程绑定的局部变量 |





### 2.2 案例演示







## 三、ThreadLocal 的内部结构

### 3.1 JDK8之前的设计

​		如果我们不去看源代码的话，可能会猜测`ThreadLocal`是这样子设计的：每个`ThreadLocal`都创建一个`Map`，然后用线程作为`Map`的`key`，要存储的局部变量作为`Map`的`value`，这样就能达到各个线程的局部变量隔离的效果。这是最简单的设计方法，JDK最早期的`ThreadLocal` 确实是这样设计的，但现在早已不是了。



















## ThreadLocal面试题

### ThreadLocal有了解过吗？它的内部结构是怎样的？

​		每个Thread类内部都有一个ThreadLocalMap，在这个Map里面，key存储的是**ThreadLocal对象**，而value存储的是**线程内变量的副本**。这个Map由ThreadLocal维护，由ThreadLocal负责向Map获取和设置线程的变量值。ThreadLocal采用以`空间换时间`的方式，为每一个线程都提供了一份变量的副本，从而实现多线程并发访问而相不干扰。

ThreadLocal的应用场景主要有以下几个方面：

- 保存线程上下文信息，在需要的地方可以获取
- 线程间数据隔离
- 保存数据库连接

|                     ThreadLocal内部结构                      |
| :----------------------------------------------------------: |
| ![image-20230301154125833](imgs\image-20230301154125833.png) |



### ThreadLocal会出现内存泄漏[^内存泄漏]的问题吗

​		ThreadLocal会出现内存泄漏问题，其主要原因是线程的私有变量ThreadLocalMap中的key是一个`弱引用`。弱引用的特性就是不管是否存在直接引用的关系，当成员变量ThreadLocal没有其它的强引用关系时，这个对象就会被GC回收，从而导致key可能会变为null，造成这块内存永远不能被访问，而导致出现内存泄漏的问题。

​		规避内存泄漏的问题我认为有两个：

- 扩大成员变量ThreadLocal的作用域，避免被GC回收。这种方法虽然不会造成key为null的现象，但是如果后续线程不会继续访问这个key，也就会导致这个内存一直占有，不被释放，最后也会造成内存溢出的问题。
- 每次使用完ThreadLocal之后，就调用`remove`手动移除对应的数据。这种方式是比较好的能解决内存泄漏的问题。













































---

[^内存泄漏]: Memory leak。是指程序中已动态分配的堆内存由于某种原因程序未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果。**内存泄漏**的堆积终将导致[^内存溢出]。
[^内存溢出]: Memory Overflow。已经没有足够的内存供申请者使用。